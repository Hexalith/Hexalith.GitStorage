@page "/GitStorageAccount/Add/GitStorageAccount"
@page "/GitStorageAccount/GitStorageAccount/{Id}"
<HexEntityDetailsPage AddTitle="@Labels.AddTitle"
                      EditTitle="@Labels.Title"
                      ViewModel="_data"
                      EntityId="@Id"
                      IndexPath="/GitStorageAccount/GitStorageAccount"
                      ValidationResult="_validationResult"
                      OnSave="OnSave"
                      OnLoadData="OnLoadDataAsync">
    <FluentAccordionItem Heading="@Labels.ApiCredentials" Expanded="true">
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
            <FluentSelect TOption="GitServerProviderType"
                          Label="@Labels.ProviderType"
                          Items="@_providerTypes"
                          OptionText="@(p => p.ToString())"
                          OptionValue="@(p => p.ToString())"
                          @bind-SelectedOption="_data.ProviderType" />
            <FluentTextField Label="@Labels.ServerUrl"
                             @bind-Value="_data.ServerUrl"
                             Placeholder="https://api.github.com" />
            <FluentTextField Label="@Labels.AccessToken"
                             @bind-Value="_data.AccessToken"
                             TextFieldType="TextFieldType.Password"
                             Placeholder="ghp_xxxxxxxxxxxx" />
        </FluentStack>
    </FluentAccordionItem>
</HexEntityDetailsPage>

@code {
    private static readonly GitServerProviderType[] _providerTypes = Enum.GetValues<GitServerProviderType>();

    [CascadingParameter]
    public Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    [Parameter]
    public string? Id { get; set; }

    private ClaimsPrincipal? _user;
    private GitStorageAccountEditViewModel _data = new();

    private ValidationResult? _validationResult; 

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask is not null)
        {
            var authState = await AuthenticationStateTask;
            if (!authState.User.Identity?.IsAuthenticated == true)
            {
                NavigationManager.NavigateTo(Application.LoginPath);
            }
            _user = authState.User;
        }
        if (_user is null)
        {
            return;
        }
        if (Id is not null)
        {
            var details = await RequestService.SubmitAsync(_user, new GetGitStorageAccountDetails(Id), CancellationToken.None);
            if (details.Result is not null)
            {
                _data = new GitStorageAccountEditViewModel(details.Result);
            }
        }
        await base.OnInitializedAsync();
    }

    protected async Task OnLoadDataAsync()
    {
        if (_user is null)
        {
            return;
        }
        if (Id is not null)
        {
            var details = await RequestService.SubmitAsync(_user, new GetGitStorageAccountDetails(Id), CancellationToken.None);
            if (details.Result is not null)
            {
                _data = new GitStorageAccountEditViewModel(details.Result);
            }
        }
    }

    private async Task<SaveResult> OnSave()
    {
        var result = _data.ValidateSave(_user, (d) =>
        {
            _validationResult = new GitStorageAccountEditValidation().Validate(d);
            if (_validationResult.IsValid)
            {
                return true;
            }
            return false;
        });
        if (result.Result == ExecuteSaveResult.Success)
        {
            await _data!.SaveAsync(_user!, CommandService, Id is null, CancellationToken.None);
            if (Id is null)
            {
                _data = new ();
            }
        }
        StateHasChanged();
        return result;
    }
}